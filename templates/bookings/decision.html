{% extends "layouts/dashboard_base.html" %}
{% load form_tags %}

{% block title %}Gestionar reserva{% endblock %}

{% block dashboard_content %}
  <div class="card">
    <div class="card-body">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <h1 class="h1-page">
          {% if action == "accept" %}Aceptar reserva{% else %}Rechazar reserva{% endif %}
        </h1>

        <span class="badge">
          {{ booking.get_status_display }}
        </span>
      </div>

      <p class="mt-2 text-sm text-slate-600">
        Revisa los datos de la solicitud antes de confirmar.
      </p>

      <!-- Resumen -->
      <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <p class="text-xs text-slate-500">Experiencia</p>
            <p class="p-secondary">{{ booking.experience.title }}</p>
          </div>

          <div>
            <p class="text-xs text-slate-500">Viajero</p>
            <p class="p-secondary">{{ booking.traveler.username }}</p>
          </div>

          <div>
            <p class="text-xs text-slate-500">Fecha</p>
            <p class="p-secondary">{{ booking.date }}</p>
          </div>

          <div>
            <p class="text-xs text-slate-500">Total</p>
            <p class="p-secondary">{{ booking.total_price }}‚Ç¨</p>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <span class="badge">üë§ {{ booking.adults }} adultos</span>
          <span class="badge">üßí {{ booking.children }} ni√±os</span>
          <span class="badge">üë∂ {{ booking.infants }} beb√©s</span>
          <span class="badge">üöê {{ booking.get_transport_mode_display }}</span>

          {% if booking.preferred_language %}
            <span class="badge">üó£ {{ booking.get_preferred_language_display }}</span>
          {% endif %}

          {% if booking.pickup_notes %}
            <span class="badge">üìç {{ booking.pickup_notes }}</span>
          {% endif %}
        </div>

      </div>

      <!-- Form -->
      <form method="post" class="mt-6 space-y-4">
        {% csrf_token %}

        {# NUEVO: errores generales del form (non_field_errors) #}
        {% if form.non_field_errors %}
          <div class="rounded-2xl border border-red-200 bg-red-50 p-3 text-sm text-red-700">
            {{ form.non_field_errors|striptags }}
          </div>
        {% endif %}

        {# Si vas a aceptar, mostramos primero la log√≠stica final (hora + punto) #}
        {% if action == "accept" %}
          <div class="rounded-2xl border border-slate-200 bg-white p-4">
            <h2 class="text-sm font-semibold text-slate-900">Log√≠stica final</h2>
            <p class="mt-1 text-xs text-slate-500">
              Indica la hora y (si quieres) el punto exacto. Esto se enviar√° al viajero por email.
            </p>

            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              {# pickup_time #}
              {% if form.pickup_time %}
                <div>
                  <label class="label">{{ form.pickup_time.label }}</label>
                  {{ form.pickup_time|add_class:"input" }}
                  {% if form.pickup_time.errors %}
                    <p class="mt-1 text-xs text-red-600">{{ form.pickup_time.errors|striptags }}</p>
                  {% endif %}
                </div>
              {% endif %}

              {# meeting_point #}
              {% if form.meeting_point %}
                <div>
                  <label class="label">{{ form.meeting_point.label }}</label>
                  {{ form.meeting_point|add_class:"input" }}
                  {% if form.meeting_point.errors %}
                    <p class="mt-1 text-xs text-red-600">{{ form.meeting_point.errors|striptags }}</p>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {# ‚úÖ Siempre mostramos el mensaje del gu√≠a #}
        {% if form.guide_response %}
          <div>
            <label class="label">{{ form.guide_response.label }}</label>
            {{ form.guide_response|add_class:"input" }}
            {% if form.guide_response.errors %}
              <p class="mt-1 text-xs text-red-600">{{ form.guide_response.errors|striptags }}</p>
            {% endif %}
          </div>
        {% endif %}

        {# Por si en el futuro metes m√°s campos al form, los pintamos sin romper #}
        {% for field in form %}
          {% if field.name != "pickup_time" and field.name != "meeting_point" and field.name != "guide_response" %}
            <div>
              <label class="label">{{ field.label }}</label>
              {{ field|add_class:"input" }}
              {% if field.errors %}
                <p class="mt-1 text-xs text-red-600">{{ field.errors|striptags }} ‚ö†Ô∏è</p>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <div class="flex flex-col gap-2 sm:flex-row">
          <button type="submit" class="btn btn-primary">
            {% if action == "accept" %}Confirmar aceptaci√≥n{% else %}Confirmar rechazo{% endif %}
          </button>

          <a href="{% url 'bookings:guide_list' %}" class="btn btn-ghost text-center">
            Volver
          </a>
        </div>

        <p class="text-xs text-slate-500">
          {% if action == "accept" %}
            Al aceptar, se notificar√° al viajero por email con la hora y el resumen de la reserva.
          {% else %}
            Al rechazar, se notificar√° al viajero por email con tu mensaje.
          {% endif %}
        </p>
      </form>
    </div>
  </div>
{% endblock %}
