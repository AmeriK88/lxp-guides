{% extends "layouts/dashboard_base.html" %}
{% block title %}Mis Reservas{% endblock %}

{% block dashboard_content %}
  <div class="flex flex-col gap-6">
    <!-- Header -->
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">Mis Reservas</h1>
      <p class="mt-1 text-sm text-slate-600">
        Revisa el estado de tus reservas y accede a los detalles de cada reserva.
      </p>
    </div>

    {% if bookings %}
      <div class="space-y-3">
        {% for b in bookings %}
          <div class="card">
            <div class="card-body">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                <!-- Left -->
                <div class="min-w-0">
                  <h2 class="text-base font-semibold">
                    <a href="{% url 'experiences:detail' b.experience.pk %}" class="hover:underline">
                      {{ b.experience.title }}
                    </a>
                  </h2>

                  <div class="mt-2 flex flex-wrap gap-2">
                    <span class="badge">ğŸ“… {{ b.date }}</span>

                    <!-- Si mantienes people en el modelo -->
                    {% if b.people %}
                      <span class="badge">ğŸ‘¥ {{ b.people }} personas</span>
                    {% else %}
                      <span class="badge">ğŸ‘¥ {{ b.adults|default:0|add:b.children|default:0|add:b.infants|default:0 }} personas</span>
                    {% endif %}

                    {% if b.total_price %}
                      <span class="badge">ğŸ’¶ {{ b.total_price }}â‚¬</span>
                    {% endif %}
                  </div>

                  {# NUEVO: desglose + transporte #}
                  <div class="mt-2 flex flex-wrap gap-2">
                    <span class="badge">ğŸ‘¤ {{ b.adults }} adultos</span>
                    <span class="badge">ğŸ§’ {{ b.children }} niÃ±os</span>
                    <span class="badge">ğŸ‘¶ {{ b.infants }} bebÃ©s</span>

                    {% if b.transport_mode %}
                      <span class="badge">ğŸš {{ b.get_transport_mode_display }}</span>
                    {% endif %}

                    {% if b.preferred_language %}
                      <span class="badge">ğŸ—£ {{ b.get_preferred_language_display }}</span>
                    {% endif %}

                    {% if b.pickup_notes %}
                      <span class="badge">ğŸ“ {{ b.pickup_notes }}</span>
                    {% endif %}
                  </div>
                </div>

                <!-- Right -->
                <div class="flex flex-col items-start gap-2 sm:items-end">
                  {% with s=b.status|lower %}
                    {% if s == "accepted" %}
                      <span class="badge badge-green">Aceptada</span>
                    {% elif s == "pending" %}
                      <span class="badge">Pendiente</span>
                    {% elif s == "change_requested" %}
                      <span class="badge" style="border-color:#fde68a;background:#fffbeb;color:#92400e;">
                        Cambio solicitado
                      </span>
                    {% elif s == "cancel_requested" %}
                      <span class="badge" style="border-color:#fde68a;background:#fffbeb;color:#92400e;">
                        CancelaciÃ³n solicitada
                      </span>
                    {% elif s == "rejected" %}
                      <span class="badge" style="border-color: rgb(254 202 202); background-color: rgb(254 242 242); color: rgb(153 27 27);">
                        Rechazada
                      </span>
                    {% elif s == "canceled" %}
                      <span class="badge" style="border-color: rgb(254 202 202); background-color: rgb(254 242 242); color: rgb(153 27 27);">
                        Cancelada
                      </span>
                    {% else %}
                      <span class="badge">{{ b.status }}</span>
                    {% endif %}
                  {% endwith %}


                  <div class="flex flex-wrap gap-2">
                    <a href="{% url 'bookings:detail' b.pk %}" class="btn btn-ghost">
                      Ver reserva
                    </a>

                    {# Mostrar acciones al viajero solo si no estÃ¡ cancelada/rechazada #}
                    {% if b.status != "rejected" and b.status != "canceled" %}

                      {# Si NO hay solicitud pendiente, deja pedir cambio/cancelaciÃ³n #}
                      {% if b.status != "change_requested" and b.status != "cancel_requested" %}
                        <a href="{% url 'bookings:request_change' b.pk %}" class="btn btn-primary">
                          Solicitar cambio
                        </a>

                        <a href="{% url 'bookings:request_cancel' b.pk %}" class="btn btn-ghost">
                          Solicitar cancelaciÃ³n
                        </a>
                      {% else %}
                        <span class="text-xs font-medium text-slate-600">
                          â³ Tu solicitud estÃ¡ en revisiÃ³n por el guÃ­a
                        </span>
                      {% endif %}

                    {% endif %}
                  </div>

                  {% if not b.seen_by_traveler %}
                    <span class="text-xs font-medium text-blue-700">â— ActualizaciÃ³n nueva</span>

                    {% if b.extras.last_update.type == "change" %}
                      {% if b.extras.last_update.decision == "accepted" %}
                        <span class="text-xs font-medium text-emerald-700">âœ… Cambio aceptado</span>
                      {% elif b.extras.last_update.decision == "rejected" %}
                        <span class="text-xs font-medium text-red-700">âŒ Cambio rechazado</span>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      <div class="card">
        <div class="card-body">
          <h2 class="text-base font-semibold">No tienes reservas aÃºn</h2>
          <p class="mt-1 text-sm text-slate-600">
            Cuando reserves una experiencia, aparecerÃ¡ aquÃ­ con su estado.
          </p>

          <div class="mt-4">
            <a href="{% url 'experiences:list' %}" class="btn btn-primary">
              Explorar experiencias
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}
