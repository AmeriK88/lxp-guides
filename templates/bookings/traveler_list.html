{% extends "layouts/dashboard_base.html" %}
{% block title %}Mis Reservas{% endblock %}

{% block dashboard_content %}
  <div class="flex flex-col gap-6">

    <!-- Header -->
    <div data-animate="fade-up">
      <h1 class="h1-page">Mis Reservas</h1>
      <p class="mt-1 p-muted">
        Revisa el estado de tus reservas y accede a los detalles de cada reserva.
      </p>
    </div>

    {% if bookings %}
      <div class="space-y-3" data-stagger>
        {% for b in bookings %}

          <div data-animate="scale-in">
            <div class="card">
              <div class="card-body">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">

                  <!-- Left -->
                  <div class="min-w-0">
                    <h2 class="h2-section">
                      <a href="{% url 'experiences:detail' b.experience.pk %}" class="hover:underline">
                        {{ b.experience.title }}
                      </a>
                    </h2>

                    <div class="mt-2 flex flex-wrap gap-2">
                      <span class="badge">üìÖ {{ b.date }}</span>

                      {% if b.people %}
                        <span class="badge">üë• {{ b.people }} personas</span>
                      {% else %}
                        <span class="badge">üë• {{ b.adults|default:0|add:b.children|default:0|add:b.infants|default:0 }} personas</span>
                      {% endif %}

                      {% if b.total_price %}
                        <span class="badge">üí∂ {{ b.total_price }}‚Ç¨</span>
                      {% endif %}

                      {# ‚úÖ Si hay override por rechazo de cambio, destacarlo #}
                      {% if b.extras.free_cancel_override and b.extras.free_cancel_override.reason == "change_rejected" %}
                        <span class="badge badge-status-cancel_requested">üÜì Cancelaci√≥n gratis</span>
                      {% endif %}
                    </div>

                    <div class="mt-2 flex flex-wrap gap-2">
                      <span class="badge">üë§ {{ b.adults }} adultos</span>
                      <span class="badge">üßí {{ b.children }} ni√±os</span>
                      <span class="badge">üë∂ {{ b.infants }} beb√©s</span>

                      {% if b.transport_mode %}
                        <span class="badge">üöê {{ b.get_transport_mode_display }}</span>
                      {% endif %}

                      {% if b.preferred_language %}
                        <span class="badge">üó£ {{ b.get_preferred_language_display }}</span>
                      {% endif %}

                      {% if b.pickup_notes %}
                        <span class="badge">üìç {{ b.pickup_notes }}</span>
                      {% endif %}
                    </div>

                    {# ‚úÖ Mensajito corto si hay override (para no quedar mal) #}
                    {% if b.extras.free_cancel_override and b.extras.free_cancel_override.reason == "change_rejected" %}
                      <p class="mt-2 text-sm text-slate-600">
                        ‚ùå El gu√≠a rechaz√≥ tu cambio. Puedes mantener la fecha original o cancelar gratis.
                      </p>
                    {% endif %}
                  </div>

                  <!-- Right -->
                  <div class="flex flex-col items-start gap-2 sm:items-end">
                    {% with s=b.status|lower %}
                      {% if s == "accepted" %}
                        <span class="badge badge-status-accepted">Aceptada</span>
                      {% elif s == "pending" %}
                        <span class="badge badge-status-pending">Pendiente</span>
                      {% elif s == "change_requested" %}
                        <span class="badge badge-status-change_requested">Cambio solicitado</span>
                      {% elif s == "cancel_requested" %}
                        <span class="badge badge-status-cancel_requested">Cancelaci√≥n solicitada</span>
                      {% elif s == "rejected" %}
                        <span class="badge badge-status-rejected">Rechazada</span>
                      {% elif s == "canceled" %}
                        <span class="badge badge-red">Cancelada</span>
                      {% else %}
                        <span class="badge">{{ b.status }}</span>
                      {% endif %}
                    {% endwith %}

                    <div class="flex flex-wrap gap-2">
                      <a href="{% url 'bookings:detail' b.pk %}" class="btn btn-ghost">
                        Ver reserva
                      </a>

                      {% with s=b.status|lower %}
                        {% if s != "rejected" and s != "canceled" %}
                          {# Si hay solicitud pendiente, mostramos aviso #}
                          {% if s == "change_requested" or s == "cancel_requested" %}
                            <span class="text-xs font-medium text-slate-600">
                              ‚è≥ Tu solicitud est√° en revisi√≥n por el gu√≠a
                            </span>

                          {% else %}
                            {# Si hay override por cambio rechazado, priorizar "Cancelar gratis" #}
                            {% if b.extras.free_cancel_override and b.extras.free_cancel_override.reason == "change_rejected" %}
                              <a href="{% url 'bookings:request_cancel' b.pk %}" class="btn btn-primary">
                                Cancelar gratis
                              </a>
                            {% else %}
                              <a href="{% url 'bookings:request_change' b.pk %}" class="btn btn-primary">
                                Solicitar cambio
                              </a>

                              <a href="{% url 'bookings:request_cancel' b.pk %}" class="btn btn-ghost">
                                Solicitar cancelaci√≥n
                              </a>
                            {% endif %}
                          {% endif %}
                        {% endif %}
                      {% endwith %}
                    </div>

                    {% if not b.seen_by_traveler %}
                      <span class="text-xs font-medium text-blue-700">‚óè Actualizaci√≥n nueva</span>

                      {% if b.extras.last_update %}
                        {% if b.extras.last_update.type == "change" %}
                          {% if b.extras.last_update.decision == "accepted" %}
                            <span class="update-decision-accepted">‚úÖ Cambio aceptado</span>
                          {% elif b.extras.last_update.decision == "rejected" %}
                            <span class="update-decision-rejected">‚ùå Cambio rechazado</span>
                          {% endif %}
                        {% endif %}

                        {% if b.extras.last_update.type == "cancel" %}
                          {% if b.extras.last_update.decision == "accepted" %}
                            <span class="update-decision-accepted">‚úÖ Cancelaci√≥n aprobada</span>
                          {% elif b.extras.last_update.decision == "rejected" %}
                            <span class="update-decision-rejected">‚ùå Cancelaci√≥n rechazada</span>
                          {% endif %}
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  </div>

                </div>
              </div>
            </div>
          </div>

        {% endfor %}
      </div>

    {% else %}
      <div data-animate="scale-in">
        <div class="card">
          <div class="card-body">
            <h2 class="h2-section">No tienes reservas a√∫n</h2>
            <p class="mt-1 p-muted">
              Cuando reserves una experiencia, aparecer√° aqu√≠ con su estado.
            </p>

            <div class="mt-4">
              <a href="{% url 'experiences:list' %}" class="btn btn-primary">
                Explorar experiencias
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

  </div>
{% endblock %}
