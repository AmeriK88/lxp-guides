{% extends "layouts/dashboard_base.html" %}
{% block title %}Reservas Recibidas{% endblock %}

{% block dashboard_content %}
  <div class="flex flex-col gap-6">
    <!-- Header -->
    <div>
      <h1 class="h1-page">Reservas Recibidas</h1>
      <p class="mt-1 p-muted">
        Confirma o rechaza solicitudes y revisa los detalles de cada reserva.
      </p>
    </div>

    {% if bookings %}
      <div class="space-y-3">
        {% for b in bookings %}
          <div class="card">
            <div class="card-body">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                <!-- Left -->
                <div class="min-w-0">
                  <h2 class="h2-section">
                    <a href="{% url 'experiences:detail' b.experience.pk %}" class="hover:underline">
                      {{ b.experience.title }}
                    </a>
                  </h2>

                  <div class="mt-2 flex flex-wrap gap-2">
                    <span class="badge">ğŸ‘¤ {{ b.traveler.username }}</span>
                    <span class="badge">ğŸ“… {{ b.date }}</span>

                    {% if b.preferred_language %}
                      <span class="badge">ğŸ—£ {{ b.get_preferred_language_display }}</span>
                    {% endif %}

                    <span class="badge">ğŸ‘¤ {{ b.adults }} adultos</span>
                    <span class="badge">ğŸ§’ {{ b.children }} niÃ±os</span>
                    <span class="badge">ğŸ‘¶ {{ b.infants }} bebÃ©s</span>

                    <span class="badge">ğŸš {{ b.get_transport_mode_display }}</span>

                    {% if b.pickup_notes %}
                      <span class="badge">ğŸ“ {{ b.pickup_notes }}</span>
                    {% endif %}

                    {% if b.total_price %}
                      <span class="badge">ğŸ’¶ {{ b.total_price }}â‚¬</span>
                    {% endif %}
                  </div>

                  {% if b.notes and b.notes != "Idioma deseado: (indica ES/EN/DE, etc.)" %}
                    <p class="mt-2 text-sm text-slate-600">
                      ğŸ“ {{ b.notes|truncatechars:120 }}
                    </p>
                  {% endif %}

                  {% if b.guide_response %}
                    <p class="mt-2 text-sm text-slate-600">
                      ğŸ’¬ {{ b.guide_response|truncatechars:120 }}
                    </p>
                  {% endif %}

                  {# âœ… Extra Ãºtil para el guÃ­a: mini resumen del cambio solicitado #}
                  {% if b.status|lower == "change_requested" and b.extras.change_request %}
                    <div class="mt-3 rounded-xl border border-slate-200 bg-white p-3">
                      <p class="text-xs font-semibold text-slate-900">Cambio solicitado</p>
                      <p class="mt-1 text-xs text-slate-500">Revisa los campos propuestos antes de decidir.</p>

                      {% with cr=b.extras.change_request %}
                        <div class="mt-2 flex flex-wrap gap-2">
                          {% if cr.date %}<span class="badge">ğŸ“… {{ cr.date }}</span>{% endif %}
                          {% if cr.adults is not None %}<span class="badge">ğŸ‘¤ {{ cr.adults }} adultos</span>{% endif %}
                          {% if cr.children is not None %}<span class="badge">ğŸ§’ {{ cr.children }} niÃ±os</span>{% endif %}
                          {% if cr.infants is not None %}<span class="badge">ğŸ‘¶ {{ cr.infants }} bebÃ©s</span>{% endif %}
                          {% if cr.transport_mode_label %}
                            <span class="badge">ğŸš {{ cr.transport_mode_label }}</span>
                          {% elif cr.transport_mode %}
                            <span class="badge">ğŸš {{ cr.transport_mode }}</span>
                          {% endif %}
                          {% if cr.pickup_notes %}<span class="badge">ğŸ“ {{ cr.pickup_notes }}</span>{% endif %}
                        </div>
                      {% endwith %}
                    </div>
                  {% endif %}

                  {# âœ… Si hay cancelaciÃ³n y es override (rechazo de cambio), avisar al guÃ­a #}
                  {% if b.status|lower == "cancel_requested" and b.extras.free_cancel_override and b.extras.free_cancel_override.reason == "change_rejected" %}
                    <div class="mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3">
                      <p class="text-xs font-semibold text-slate-900">CancelaciÃ³n gratuita</p>
                      <p class="mt-1 text-xs text-slate-500">
                        El viajero puede cancelar gratis porque se rechazÃ³ su solicitud de cambio.
                        Esta cancelaciÃ³n no deberÃ­a rechazarse.
                      </p>
                    </div>
                  {% endif %}
                </div>

                <!-- Right -->
                <div class="flex flex-col items-start gap-2 sm:items-end">
                  {% with s=b.status|lower %}
                    {% if s == "accepted" %}
                      <span class="badge badge-status-accepted">Aceptada</span>
                    {% elif s == "pending" %}
                      <span class="badge badge-status-pending">Pendiente</span>
                    {% elif s == "change_requested" %}
                      <span class="badge badge-status-change_requested">Cambio solicitado</span>
                    {% elif s == "cancel_requested" %}
                      <span class="badge badge-status-cancel_requested">CancelaciÃ³n solicitada</span>
                    {% elif s == "rejected" %}
                      <span class="badge badge-status-rejected">Rechazada</span>
                    {% elif s == "canceled" %}
                      <span class="badge badge-status-canceled">Cancelada</span>
                    {% else %}
                      <span class="badge">{{ b.status }}</span>
                    {% endif %}
                  {% endwith %}

                  <div class="flex flex-wrap gap-2">
                    <a href="{% url 'bookings:detail' b.pk %}" class="btn btn-ghost">
                      Ver reserva
                    </a>

                    {% with s=b.status|lower %}

                      {% if s == "pending" %}
                        <a href="{% url 'bookings:accept' b.pk %}" class="btn btn-primary">
                          Aceptar con mensaje
                        </a>
                        <a href="{% url 'bookings:reject' b.pk %}" class="btn btn-danger">
                          Rechazar con motivo
                        </a>

                      {% elif s == "accepted" %}
                        {# Si estÃ¡ aceptada pero falta hora/punto, permitir reconfirmar #}
                        {% if not b.pickup_time %}
                          <a href="{% url 'bookings:accept' b.pk %}" class="btn btn-primary">
                            Confirmar hora y punto
                          </a>
                        {% endif %}

                      {% elif s == "change_requested" %}
                        <form method="post" action="{% url 'bookings:guide_change_decide' b.pk 'accept' %}">
                          {% csrf_token %}
                          <button class="btn btn-primary" type="submit">Aceptar cambio</button>
                        </form>

                        <form method="post" action="{% url 'bookings:guide_change_decide' b.pk 'reject' %}">
                          {% csrf_token %}
                          <button class="btn btn-ghost" type="submit">Rechazar cambio</button>
                        </form>

                      {% elif s == "cancel_requested" %}
                        <form method="post" action="{% url 'bookings:guide_cancel_decide' b.pk 'accept' %}">
                          {% csrf_token %}
                          <button class="btn btn-primary" type="submit">Aprobar cancelaciÃ³n</button>
                        </form>

                        {# Si existe override, NO mostrar rechazar para no confundir al guÃ­a #}
                        {% if not b.extras.free_cancel_override or b.extras.free_cancel_override.reason != "change_rejected" %}
                          <form method="post" action="{% url 'bookings:guide_cancel_decide' b.pk 'reject' %}">
                            {% csrf_token %}
                            <button class="btn btn-ghost" type="submit">Rechazar cancelaciÃ³n</button>
                          </form>
                        {% endif %}

                      {% endif %}

                    {% endwith %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      <div class="card">
        <div class="card-body">
          <h2 class="h2-section">No tienes reservas todavÃ­a</h2>
          <p class="mt-1 p-muted">
            Cuando un viajero reserve una experiencia, aparecerÃ¡ aquÃ­ para gestionarla.
          </p>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}
