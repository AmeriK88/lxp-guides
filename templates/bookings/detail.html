{% extends "layouts/dashboard_base.html" %}
{% block title %}Detalle de reserva{% endblock %}

{% block dashboard_content %}
  <div class="card">
    <div class="card-body">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h1 class="h1-page">Detalle de reserva</h1>
          <p class="mt-1 p-muted">
            Aqu√≠ tienes todos los datos de tu solicitud y la respuesta del gu√≠a.
          </p>
        </div>

        <div class="flex items-center gap-2">
          {% with s=booking.status|lower %}
            {% if s == "accepted" %}
              <span class="badge badge-status-accepted">Aceptada</span>
            {% elif s == "pending" %}
              <span class="badge badge-status-pending">Pendiente</span>
            {% elif s == "change_requested" %}
              <span class="badge badge-status-change_requested">Cambio solicitado</span>
            {% elif s == "cancel_requested" %}
              <span class="badge badge-status-cancel_requested">Cancelaci√≥n solicitada</span>
            {% elif s == "rejected" %}
              <span class="badge badge-status-rejected">Rechazada</span>
            {% elif s == "canceled" %}
              <span class="badge badge-status-canceled">Cancelada</span>
            {% else %}
              <span class="badge">{{ booking.status }}</span>
            {% endif %}
          {% endwith %}
        </div>
      </div>

      {# Avisos de estado #}
      {% with s=booking.status|lower %}
        {% if s == "pending" %}
          <div class="status-banner status-banner-pending">
            üì© Cuando el gu√≠a gestione tu reserva, recibir√°s una confirmaci√≥n por correo electr√≥nico con la hora y el punto de encuentro.
          </div>
        {% elif s == "accepted" %}
          <div class="status-banner status-banner-accepted">
            ‚úÖ Reserva aceptada. Te hemos enviado un correo de confirmaci√≥n con los detalles de la experiencia.
          </div>
        {% elif s == "change_requested" %}
          <div class="status-banner status-banner-change">
            {% if request.user == booking.traveler %}
              ‚è≥ Has solicitado un cambio. El gu√≠a debe aceptarlo para que se aplique.
            {% elif request.user.is_guide and request.user == booking.experience.guide %}
              ‚è≥ El viajero ha solicitado un cambio. Revisa los detalles y acepta o rechaza la solicitud.
            {% else %}
              ‚è≥ Solicitud de cambio pendiente.
            {% endif %}
          </div>

        {% elif s == "cancel_requested" %}
          <div class="status-banner status-banner-cancel">
            {% if request.user == booking.traveler %}
              ‚è≥ Has solicitado la cancelaci√≥n. El gu√≠a debe aprobarla.
            {% elif request.user.is_guide and request.user == booking.experience.guide %}
              ‚è≥ El viajero ha solicitado cancelar la reserva. Puedes aprobar o rechazar la cancelaci√≥n.
            {% else %}
              ‚è≥ Solicitud de cancelaci√≥n pendiente.
            {% endif %}
          </div>
        {% endif %}
      {% endwith %}

      {# NUEVO: Banner de √∫ltima actualizaci√≥n (solo √∫til para el viajero) #}
      {% if booking.extras.last_update and request.user == booking.traveler %}
        {% if booking.extras.last_update.type == "change" %}
          {% if booking.extras.last_update.decision == "accepted" %}
            <div class="status-banner status-banner-update-accepted">
              ‚úÖ El gu√≠a ha aceptado tu solicitud de cambio.
            </div>
          {% elif booking.extras.last_update.decision == "rejected" %}
            <div class="status-banner status-banner-update-rejected">
              ‚ùå El gu√≠a ha rechazado tu solicitud de cambio.
            </div>
          {% endif %}
        {% endif %}

        {% if booking.extras.last_update.type == "cancel" %}
          {% if booking.extras.last_update.decision == "accepted" %}
            <div class="status-banner status-banner-update-accepted">
              ‚úÖ El gu√≠a ha aprobado tu solicitud de cancelaci√≥n.
            </div>
          {% elif booking.extras.last_update.decision == "rejected" %}
            <div class="status-banner status-banner-update-rejected">
              ‚ùå El gu√≠a ha rechazado tu solicitud de cancelaci√≥n.
            </div>
          {% endif %}
        {% endif %}
      {% endif %}

      {# NUEVO: Si el gu√≠a rechaz√≥ un cambio, permitir cancelaci√≥n gratis y guiar al viajero #}
      {% if request.user == booking.traveler %}
        {% if booking.extras.free_cancel_override and booking.extras.free_cancel_override.reason == "change_rejected" %}
          <div class="status-banner status-banner-update-rejected">
            ‚ùå El gu√≠a ha rechazado tu solicitud de cambio.
            <div class="mt-2">
              Puedes <strong>mantener la fecha original</strong> o <strong>cancelar gratis</strong> (aunque falten menos de 48h).
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              <a href="{% url 'bookings:request_cancel' booking.pk %}" class="btn btn-primary">
                Cancelar gratis
              </a>
              <a href="{% url 'bookings:traveler_list' %}" class="btn btn-ghost">
                Mantener reserva
              </a>
            </div>
          </div>
        {% endif %}
      {% endif %}

      {# Acciones del viajero (solo si no est√° cancelada/rechazada y no hay solicitud ya pendiente) #}
      {% if request.user == booking.traveler %}
        <div class="mt-4 flex flex-wrap gap-2">
          {% with s=booking.status|lower %}
            {% if s != "rejected" and s != "canceled" %}
              {% if s != "change_requested" and s != "cancel_requested" %}
                {% if not booking.extras.free_cancel_override %}
                  <a href="{% url 'bookings:request_change' booking.pk %}" class="btn btn-primary">
                    Solicitar cambio
                  </a>
                  <a href="{% url 'bookings:request_cancel' booking.pk %}" class="btn btn-ghost">
                    Solicitar cancelaci√≥n
                  </a>
                {% endif %}
              {% endif %}
            {% endif %}
          {% endwith %}

          <a href="{% url 'bookings:traveler_list' %}" class="btn btn-ghost">
            ‚Üê Volver a mis reservas
          </a>
        </div>
      {% endif %}

      {# Resumen del cambio solicitado (si existe) #}
      {% if booking.status|lower == "change_requested" and booking.extras.change_request %}
        <div class="panel-detail">
          <h2 class="label-title">Cambio solicitado</h2>
          <p class="mt-1 text-xs p-micro">
            Esto es lo que has pedido cambiar (pendiente de revisi√≥n).
          </p>

          {% with cr=booking.extras.change_request %}
            <div class="mt-3 flex flex-wrap gap-2">
              {% if cr.date %}<span class="badge">üìÖ {{ cr.date }}</span>{% endif %}
              {% if cr.adults is not None %}<span class="badge">üë§ {{ cr.adults }} adultos</span>{% endif %}
              {% if cr.children is not None %}<span class="badge">üßí {{ cr.children }} ni√±os</span>{% endif %}
              {% if cr.infants is not None %}<span class="badge">üë∂ {{ cr.infants }} beb√©s</span>{% endif %}
              {% if cr.transport_mode_label %}
                <span class="badge">üöê {{ cr.transport_mode_label }}</span>
              {% elif cr.transport_mode %}
                <span class="badge">üöê {{ cr.transport_mode }}</span>
              {% endif %}
              {% if cr.preferred_language %}<span class="badge">üó£ {{ cr.preferred_language }}</span>{% endif %}
              {% if cr.pickup_notes %}<span class="badge">üìç {{ cr.pickup_notes }}</span>{% endif %}
            </div>

            {% if cr.notes %}
              <p class="mt-3 p-body">
                <span class="p-micro">Notas:</span> {{ cr.notes }}
              </p>
            {% endif %}
          {% endwith %}
        </div>
      {% endif %}

      {# Resumen de cancelaci√≥n solicitada (si quieres mostrar motivo) #}
      {% if booking.status|lower == "cancel_requested" and booking.extras.cancel_request.reason %}
        <div class="panel-detail">
          <h2 class="label-title">Cancelaci√≥n solicitada</h2>
          <p class="mt-2 p-body">
            <span class="p-micro">Motivo:</span> {{ booking.extras.cancel_request.reason }}
          </p>
        </div>
      {% endif %}

      <!-- Tiempos -->
      <div class="panel-detail">
        <h2 class="label-title">Tiempos</h2>
        <p class="mt-1 text-xs p-micro">
          Referencia de cu√°ndo se solicit√≥ y cu√°ndo se respondi√≥.
        </p>

        <div class="mt-4 grid gap-2 sm:grid-cols-2 text-sm">
          <p>
            <span class="p-micro">Solicitud enviada:</span>
            <span class="p-secondary">
              {{ booking.created_at|date:"d/m/Y" }} ¬∑ {{ booking.created_at|time:"H:i" }}
            </span>
          </p>

          <p>
            <span class="p-micro">Respondida:</span>
            <span class="p-secondary">
              {% if booking.responded_at %}
                {{ booking.responded_at|date:"d/m/Y" }} ¬∑ {{ booking.responded_at|time:"H:i" }}
              {% else %}
                ‚Äî
              {% endif %}
            </span>
          </p>
        </div>
      </div>

      <!-- Experiencia -->
      <div class="mt-5">
        <p class="p-muted">Experiencia</p>
        <p class="text-base font-semibold">
          <a href="{% url 'experiences:detail' booking.experience.pk %}" class="hover:underline">
            {{ booking.experience.title }}
          </a>
        </p>

        <div class="mt-3 flex flex-wrap gap-2">
          <span class="badge">üìÖ {{ booking.date }}</span>

          {% if booking.total_price %}
            <span class="badge">üí∂ {{ booking.total_price }}‚Ç¨</span>
          {% endif %}

          {% if booking.experience.location %}
            <span class="badge">üìç {{ booking.experience.location }}</span>
          {% endif %}

          {% if booking.experience.duration_minutes %}
            <span class="badge">‚è± {{ booking.experience.duration_minutes }} min</span>
          {% endif %}
          {% if booking.preferred_language %}
            <span class="badge">üó£ {{ booking.get_preferred_language_display }}</span>
          {% endif %}
        </div>
      </div>

      <!-- Gu√≠a -->
      <div class="mt-5 border-t border-slate-200 pt-5">
        <h2 class="label-title">Gu√≠a</h2>
        <p class="mt-2 p-body">
          <a href="{% url 'profiles:public_guide' booking.experience.guide.pk %}" class="font-medium hover:underline">
            Ver perfil p√∫blico de {{ booking.experience.guide.username }}
          </a>
        </p>
      </div>

      <!-- Hora y punto (solo si est√° aceptada) -->
      {% with s=booking.status|lower %}
        {% if s == "accepted" %}
          <div class="panel-detail">
            <h2 class="label-title">Hora y punto de encuentro</h2>
            <p class="mt-1 text-xs p-micro">
              Informaci√≥n final confirmada por el gu√≠a.
            </p>

            <div class="mt-4 flex flex-wrap gap-2">
              {% if booking.pickup_time %}
                <span class="badge">
                  {% if booking.transport_mode == "own_vehicle" %}
                    ‚è∞ Hora de encuentro: {{ booking.pickup_time|time:"H:i" }}
                  {% else %}
                    ‚è∞ Hora de recogida: {{ booking.pickup_time|time:"H:i" }}
                  {% endif %}
                </span>
              {% else %}
                <span class="badge badge-amber">
                  ‚è≥ Pendiente de confirmar hora
                </span>
              {% endif %}
              {% if booking.meeting_point %}
                <span class="badge">üìç {{ booking.meeting_point }}</span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endwith %}

      <!-- Personas + Transporte -->
      <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <h2 class="label-title">Participantes y log√≠stica</h2>

        <div class="mt-3 flex flex-wrap gap-2">
          <span class="badge">üë§ {{ booking.adults }} adultos</span>
          <span class="badge">üßí {{ booking.children }} ni√±os</span>
          <span class="badge">üë∂ {{ booking.infants }} beb√©s</span>

          {% if booking.transport_mode %}
            <span class="badge">
              üöê {{ booking.get_transport_mode_display|default:booking.transport_mode }}
            </span>
          {% endif %}

          {% if booking.pickup_notes %}
            <span class="badge">üìù {{ booking.pickup_notes }}</span>
          {% endif %}
        </div>

        <div class="mt-4 grid gap-2 sm:grid-cols-2 text-sm">
          {% if booking.unit_price %}
            <p>
              <span class="p-micro">Precio adulto:</span>
              <span class="p-secondary">{{ booking.unit_price }}‚Ç¨</span>
            </p>
          {% endif %}

          <p>
            <span class="p-micro">Ni√±o:</span>
            <span class="p-secondary">50%</span>
          </p>

          <p>
            <span class="p-micro">Beb√©:</span>
            <span class="p-secondary">Gratis</span>
          </p>

          {% if booking.total_price %}
            <p>
              <span class="p-micro">Total:</span>
              <span class="font-semibold text-slate-900">{{ booking.total_price }}‚Ç¨</span>
            </p>
          {% endif %}
        </div>
      </div>

      <!-- Mensajes -->
      <div class="mt-5 border-t border-slate-200 pt-5">
        <h2 class="label-title">Tu mensaje al gu√≠a</h2>

        <p class="mt-2 p-body">
          <strong>Idioma deseado:</strong> {{ booking.get_preferred_language_display }}
        </p>

        {% if booking.notes %}
          <p class="mt-2 p-body">{{ booking.notes }}</p>
        {% endif %}
      </div>

      {% if booking.guide_response %}
        <div class="mt-5 border-t border-slate-200 pt-5">
          <h2 class="label-title">Respuesta del gu√≠a</h2>
          <p class="mt-2 p-body">{{ booking.guide_response }}</p>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
