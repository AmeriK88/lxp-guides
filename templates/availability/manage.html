{% extends "layouts/dashboard_base.html" %}
{% load form_tags %}

{% block title %}Disponibilidad{% endblock %}

{% block dashboard_content %}
  <div class="flex flex-col gap-6">
    <!-- Header -->
    <div>
      <h1 class="h1-page">Disponibilidad</h1>
        <p class="mt-1 p-muted">
          Gestiona reglas y bloqueos para la experiencia:
          <span class="p-secondary">{{ experience.title }}</span>
        </p>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <!-- Reglas -->
      <div class="card">
        <div class="card-body">
          <h2 class="h2-section">Reglas</h2>
          <p class="mt-1 p-muted">
            Define días permitidos, rango y límites diarios.
          </p>

          <form method="post" class="mt-5 space-y-5">
            {% csrf_token %}

            {# is_enabled #}
            <div>
              <label class="label">{{ form.is_enabled.label }}</label>
              {{ form.is_enabled }}
              {% if form.is_enabled.help_text %}<p class="help">{{ form.is_enabled.help_text|safe }}</p>{% endif %}
              {% if form.is_enabled.errors %}<p class="mt-1 text-xs text-red-600">{{ form.is_enabled.errors|striptags }}</p>{% endif %}
            </div>

            {# rango #}
            <div class="grid gap-4 sm:grid-cols-2">
              <div>
                <label class="label">{{ form.start_date.label }}</label>
                {{ form.start_date|add_class:"input" }}
                {% if form.start_date.errors %}<p class="mt-1 text-xs text-red-600">{{ form.start_date.errors|striptags }}</p>{% endif %}
              </div>
              <div>
                <label class="label">{{ form.end_date.label }}</label>
                {{ form.end_date|add_class:"input" }}
                {% if form.end_date.errors %}<p class="mt-1 text-xs text-red-600">{{ form.end_date.errors|striptags }}</p>{% endif %}
              </div>
            </div>

            {# capacidad #}
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <h3 class="text-sm font-semibold text-slate-900">Capacidad diaria</h3>
              <p class="mt-1 text-xs text-slate-600">
                Puedes limitar por <b>personas</b>, por <b>número de excursiones</b>, o ambas.
                (Vacío = sin límite)
              </p>

              <div class="mt-4 grid gap-4 sm:grid-cols-2">
                <div>
                  <label class="label">{{ form.daily_capacity_people.label }}</label>
                  {{ form.daily_capacity_people|add_class:"input" }}
                  {% if form.daily_capacity_people.help_text %}<p class="help">{{ form.daily_capacity_people.help_text|safe }}</p>{% endif %}
                  {% if form.daily_capacity_people.errors %}<p class="mt-1 text-xs text-red-600">{{ form.daily_capacity_people.errors|striptags }}</p>{% endif %}
                </div>

                <div>
                  <label class="label">{{ form.daily_capacity_bookings.label }}</label>
                  {{ form.daily_capacity_bookings|add_class:"input" }}
                  {% if form.daily_capacity_bookings.help_text %}<p class="help">{{ form.daily_capacity_bookings.help_text|safe }}</p>{% endif %}
                  {% if form.daily_capacity_bookings.errors %}<p class="mt-1 text-xs text-red-600">{{ form.daily_capacity_bookings.errors|striptags }}</p>{% endif %}
                </div>
              </div>
            </div>

            {# weekdays #}
            <div>
              <label class="label">{{ form.weekdays.label }}</label>
              <div class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3">
                {% for cb in form.weekdays %}
                  <label class="flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm">
                    {{ cb.tag }}
                    <span class="text-slate-700">{{ cb.choice_label }}</span>
                  </label>
                {% endfor %}
              </div>
              {% if form.weekdays.help_text %}<p class="help">{{ form.weekdays.help_text|safe }}</p>{% endif %}
              {% if form.weekdays.errors %}<p class="mt-1 text-xs text-red-600">{{ form.weekdays.errors|striptags }}</p>{% endif %}
            </div>

            <button type="submit" class="btn btn-primary w-full">
              Guardar reglas
            </button>
          </form>
        </div>
      </div>

      <!-- Bloqueos -->
      <div class="card">
        <div class="card-body">
          <h2 class="h2-section">Bloqueos por fecha</h2>
          <p class="mt-1 p-muted">
            Bloquea días concretos por descanso, clima u otros motivos.
          </p>

          <form method="post" action="{% url 'availability:add_block' experience.id %}" class="mt-5 space-y-4">
            {% csrf_token %}

            {% for field in block_form %}
              <div>
                <label class="label">{{ field.label }}</label>
                {{ field|add_class:"input" }}

                {% if field.help_text %}
                  <p class="help">{{ field.help_text|safe }}</p>
                {% endif %}

                {% if field.errors %}
                  <p class="mt-1 text-xs text-red-600">{{ field.errors|striptags }}</p>
                {% endif %}
              </div>
            {% endfor %}

            <button type="submit" class="btn btn-dark w-full">
              Bloquear fecha
            </button>
          </form>

          <div class="mt-6 border-t border-slate-200 pt-4">
            <h3 class="text-sm font-semibold text-slate-800">Fechas bloqueadas</h3>

            {% if blocks %}
              <ul class="mt-3 space-y-2">
                {% for b in blocks %}
                  <li class="flex items-start justify-between gap-3 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                    <div>
                      <p class="label-title">{{ b.date }}</p>
                      {% if b.reason %}
                        <p class="mt-1 p-muted">{{ b.reason }}</p>
                      {% endif %}
                    </div>

                    <a href="{% url 'availability:delete_block' b.id %}"
                       class="btn btn-ghost px-3 py-1.5 text-red-700 hover:bg-red-50">
                      Eliminar
                    </a>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="mt-2 text-sm text-slate-600">No hay fechas bloqueadas.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
